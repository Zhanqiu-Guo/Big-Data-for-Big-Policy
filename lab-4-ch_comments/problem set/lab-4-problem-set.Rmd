---
title: "Lab 4 Problem Set"
always_allow_html: true
output: md_document
---

<br>
<hr>
<br>

# Submission Instructions

Download the lab-four-problem-set.rmd file from GitHub and code your
answers in that file. Rename the file lastname_firstname_lab1.md. You must knit your .rmd as an .md. Upload your problem set through the Assignments tab in Canvas by July 29th at 12PM. Remember that in an R Markdown file writing in the white space will be read as text, so you write responses to your questions in the white space.

# Data Overview

Our data represents crime rates by county in New York from 2016-2018. Crime rates are reported using three categories: Index, Violent, and Property Crimes. Data was collected from https://www.criminaljustice.ny.gov/crimnet/ojsa/countycrimestats.html. We also have demographic information for each county collected from the United States Census. Definitions for each variables are below.

Variables:

| Variable | Description |
| ----------- | ----------- |
| `gisjoin` | GIS unique id that allows the user to merge data to a county GIS shapefile |
| `year` | Year the data was collected. Census data was collected between 2014-2018 and is presented as a weighted average, but we should think of all demographic data as coming from 2016. |
| `county/countyname` | County name |
| `countya/countfip` | County FIPS code |
| `male` | male represents the total number of individuals who identify as male overall and by the following age groups: under 18, 18 to 34 years of age, 35 to 64 years of age, and 65 or older. The total number of individuals who were surveyed to obtain these statistics are found in sex by age: total population |
| `female` | female represents the total number of individuals who identify as female overall and by the following age groups: under 18, 18 to 34 years of age, 35 to 64 years of age, and 65 or older. The total number of individuals who were surveyed to obtain these statistics are found in sex by age: total population |
| `race` | Race represents the total number of individuals who identify as white, Black, Asian, American Indian, Nativan Hawaiian or other. The total number of individuals who were surveyed to obtain these statistics are found in Race: total population |
| `education` | Education represents the total number of individuals who have achieved a certain level of education as defined by HS degree or less, some college, and college or more. The total number of individuals who were surveyed to obtain these statistics are found in education: total population |
| `median household income` | The median household income  |
| `proportion (un)employed in civilian labor force` | Of the civilian labor force, these are the proportions (0-1) of individuals who are either employed or unemployed. This does not include those serving in the armed forces or those that are not in the civilian labor force (e.g., individuals over 65) |
| `population` | The total number of indivudals living in the county |
| `index crime` | Index crimes include all counts of murder and nonnegligent homicide, rape, robbery, aggravated assualt, burglary, motor vehicle theft, larceny-theft, and arson |
| `violent crime` | Violent crime is defined as an event where an offender or perpetrator uses or threatens to use force upon a victim |
| `property crime` | Property crime is defined as an event where a victim's property is stolen or destroyed without the use or threat of force against the victim. This is represented as an overall count of occurences and a rate per |
| `new york city` | This is an indicator stating whether the county is in New York City |

# Problem Set Questions  

## 1. Read in the crime data using the `renamefrom()` function. You will need to create a crosswalk. 

```{r}
library(collapse)
require(doBy)
library(visreg)
library(tidyverse)
library(crosswalkr)
library(zoo)
library(randomForest)
library(readxl)
c2016 <- read_xlsx('./problem-set-4-data/2016-county-index-rates.xlsx')
c2017 <- read_xlsx('./problem-set-4-data/2017-county-index-rates.xlsx')
c2018 <- read_xlsx('./problem-set-4-data/2018-county-index-rates.xlsx')
crosswalk <- read.csv('./problem-set-4-data/crosswalk.csv')
cf2016 <- renamefrom(c2016, crosswalk, a2016, VarName)
cf2017 <- renamefrom(c2017, crosswalk, a2017, VarName)
cf2018 <- renamefrom(c2018, crosswalk, a2018, VarName)
cf <- rbind(cf2016,cf2017,cf2018)
```

## 2. Merge in the demographic data. Examine your variables. Correct the three variables that are incorrectly coded. You need to determine which variables these are by viewing your data and running the checks we learned in lab 1. 

```{r}
dg <- read.csv('./problem-set-4-data/ny_demographic_census.csv')
cfdg <- left_join(cf, dg, by = 'GISJOIN')
head(cfdg)
tail(cfdg)
```

## 3. Write a null and alternative hypothesis that you can feasibly answer with your data (e.g., crime rates (consider overall, index, violent, or property) are higher in counties with higher proportions of X). Your hypothesis should NOT be related to time; we will examine this later. 

Write your answer here 
The index crime rate is higher in counties with higher proportion of unemployed in civilian labor force.

## 4. Run a preliminary correlation for your hypothesis. Report on the strength of the relationship, the significance level, and whether the correlation supports your null or alternative hypothesis. (HINT: If you use a demographic variable that is reported as a count, you will need to turn this into a proportion. Also consider whether your variable makes sense on its own). 

The p-value is close to 0. The relation is significant. The cor-value is about 0.25, which is a moderate positive correlation. The relation test supports the hypothesis.

```{r}
cor.test(cfdg$IC_Rate,cfdg$Proportion.Unemployed.in.Civilian.Labor.Force,method = 'pearson')
```

## 5. Run a ttest for your hypothesis. In order to run a ttest, your independent variable will need to be binary (or coded as 0 v 1). Recall we created indicators in lab 1. Write a rationale for why you split your variable the way you did. Report the means of your outcome for the two groups you created, and the significance level from the ttest. Compare your findings here to step 4. Speak to similarities and differences between the two tests. 

Write your response here 
I choose the median  value as the boundary because it could indicate the overall data. The mean of IC_Rate for the group with unemployment rate higher than average has a higher value, which is 1904. The other group is 1556. 
The p-value is about 0.0019, which is still significant, but larger than the one in part 4. This t-test also shows the significant positive relation between index crime rate and unemployment rate. 

```{r}
cfdg$un <- cfdg$Proportion.Unemployed.in.Civilian.Labor.Force >= mean(cfdg$Proportion.Unemployed.in.Civilian.Labor.Force) 

aggregate(cfdg$IC_Rate, list(cfdg$un), mean)

pairwise.t.test(cfdg$IC_Rate, cfdg$un,
                 p.adjust.method = "BH")
```

## 6. What other variables do you think could explain the relationship you found in step 4? Write at least 2 other variables you think could attenuate (or weaken) your relationship and explain why. If necessary, recode the variables in this section. The way you code your variables will help you tell your story later on. Finally, thinking back to lab 4 write 1 sentence about whether it make sense to use factors you use factors? 

Write your response here
The median income and education level may also has effect. The unemployment might not be the cause of crime. The unemployment may caused by the low education level. The low education level might be the cause instead. Moreover, the unemployment may cause a low income, which is probably the direct cause of crime. Although people are unemployed, if their family still has a high household income, or they have higher education level, it is less likely for them to commit a crime. It is unreasonable for  considering the unemployed rate as the only factor.

```{r}
EDU <- lm(IC_Rate ~ Proportion.Unemployed.in.Civilian.Labor.Force + College.or.More/Education..Total.Population, data=cfdg)
Income <- lm(IC_Rate ~ Proportion.Unemployed.in.Civilian.Labor.Force + Median.Household.Income, data=cfdg)
summary(EDU)
summary(Income)
```


## 7. Create a graph/plot/map of your choice that examines your hypothesis from step 3/4. Replicate your graph/plot/map but this time adding in trends for the different groups you identified in step 6. Write 1-2 sentences briefly summarizing what you find. (HINT: Think about whether a line graph or a bar chart makes more sense for this exercise. Feel free to get creative here. You may add in a time dimension if you would like, though it is not necessary).

```{r}
ggplot (cfdg, aes(y = IC_Rate, x = Proportion.Unemployed.in.Civilian.Labor.Force)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "IC_Rate", x = "Unemployed proportion", title = "Unemployed proportion by IC_Rate")
```
It correspond to the hypothesis in 3/4,where there is a positive relation between unemployed proportion and IC_Rate.
```{r}
ggplot (cfdg, aes(y = IC_Rate, x = Proportion.Unemployed.in.Civilian.Labor.Force, group=College.or.More/Education..Total.Population>mean(College.or.More/Education..Total.Population))) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "IC_Rate", x = "Unemployed proportion", title = "Unemployed proportion by IC_Rate with control of education level")
```
```{r}
ggplot (cfdg, aes(y = IC_Rate, x = Proportion.Unemployed.in.Civilian.Labor.Force, group=Median.Household.Income>mean(Median.Household.Income))) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(y = "IC_Rate", x = "Unemployed proportion", title = "Unemployed proportion by IC_Rate with control of income")
```
Both of them become flatter and having a higher intercept.With these controls, the relation between unemployment and crime rate become weaker. This means some part of the relation is explained through factors controled, income and education. 

## 8. Run three linear models. The first model should be the "naive" model that only examines the relationship between your outcome and independent variable (identified in step 4). Your second model should be your "control" model where you add in the groups you identified in step 6. Your final model is another "control" model where you add year to your model (add year by itself removing the groups from your second model). Write 3-4 sentences interpreting the estimates between your naive and control models. Pay particular attention to estimates, significance, and your r-squared and compare between your models. Think hard about what your estimates actually mean. Your interpration of the estimates depend on how your outcome variable was coded.

```{r}
Lunemployed <- lm(IC_Rate ~ Proportion.Unemployed.in.Civilian.Labor.Force, data=cfdg)
Lcontrol <- lm(IC_Rate ~ Proportion.Unemployed.in.Civilian.Labor.Force + Median.Household.Income + College.or.More/Education..Total.Population, data=cfdg)
Lyear <- lm(IC_Rate ~ Proportion.Unemployed.in.Civilian.Labor.Force + Year, data=cfdg)
summary(Lunemployed)
summary(Lcontrol)
summary(Lyear)
```
With the control group, there is a larger R-square value and smaller p-value, which means the relation is better explained by the model with control groups. However, the model with year control has larger p-value and smaller R-square. Therefore, year is not related to the crime rate.

## 9. Visualize your regressions by graphing the residuals from both your naive and control models in step 8. Write 3-4 setences explaining what the graphs show, paying particular attention to the interpretation of your confidence intervals.

```{r}
visreg(Lunemployed, "Proportion.Unemployed.in.Civilian.Labor.Force", type = "contrast")
visreg(Lcontrol, "Proportion.Unemployed.in.Civilian.Labor.Force", type = "contrast")
```
The naive one has an increasing large residual with the increase of unemployment rate. This means the naive model can't explain well when unemployment increase. The control model has residuals almost zero, which means the model could explain well at any state. However, it has a large confidence intervals, which means there is a probability that the model are not fully explaining the relation.

## 10. For a policy leader of your choice, explain your hypothesis and why it is important for them to consider. Next summarize your findings. Finally, recall that our data represents counties in New York State for the years 2016 to 2018. What other data would you like in order to better understand your hypotheses (e.g., time points, neighborhoods)? How would this data better help you answer the question you are interested in? Specifically speak to HOW this new data would allow you to isolate the relationship you're interested in. Write 2-3 paragraphs.

Write your answer here.
Unemployment rate has a correlation with the index crime rate. However, the direct reason is the education level and household income. Therefore, to decrease the index crime rate, it is better to encourage and support education, subsidizing poor families. However, the average education level and average household income may vary from state to state. To better understand the relation, there should be data in other state. These data will help me to determine whether the crime rate is related to the average value in each place or not. (e.g.Suppose one state has high average education and income level and the other low value. If there are two counties with same edu and income level, whether the county in high value state will have a high index rate or not.) The geographical environment may also affect the value in different state. To eliminate such variation, I could use the data in one state but in different year. Since the original data is from 2016 to 2018, which is too short, a data with longer time lag would be preferable.  To isolate such relation, I  could set a control with the average edu and income of each state and year and do the linear model. 
