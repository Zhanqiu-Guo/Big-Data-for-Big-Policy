---
title: "Lab 2 Problem Set"
always_allow_html: true
output: md_document
---

# Hands-on Task 1: Wrangle the Craigslist data

Here you will use `dplyr` to complete process the listing data that we started with to get a feel for writing data manipulation code. Once we are done preparing the data, we will do some basic data visualization and statistical analysis to understand patterns and relationships within the data.

## Load the listing data.

```{r}
library(dplyr)
library(tidyverse) 
library(sf)       
library(lubridate)
library(leaflet)
load("./input/ithaca_rentals.RData")
```

## Create a new data frame that is limited to 1 bedroom units.

```{r}
one_bedroom <- filter(scraped, scraped_beds == "1BR")
```

## Mutate fields in `scraped` that are currently character but should be numeric as new columns.

```{r}
scraped <- mutate(scraped,clean_rent = parse_number(scraped_rent),
                  clean_sqft = parse_number(scraped_sqft),
                  clean_baths = parse_number(scraped_baths))
```

## Create a new data frame with listings that mention "affordable" in their title

```{r}
affordable <- filter(scraped, str_detect(listing_title, pattern = "affordable"))
```

## Create a column in `scraped` indicating whether the rent asked is more than $800.

```{r}
scraped <- mutate(scraped, scraped_rent > 800)
```

## Create a new data frame that only has the `listing_title` and our new numeric columns using `where()` and `is_numeric()`.

```{r}
char_cols <- select(scraped, where(is_numeric),listing_title)
```

## Create a summary statistic table with the minimum, maximum and average rent values for 1 bedroom units, as well as the number of 1 bedroom units in the data.

```{r}
summarize(one_bedroom,min_1b=min(parse_number(scraped_rent),na.rm = T),
          max_1b=max(parse_number(scraped_rent),na.rm = T),
          mean_1b=mean(parse_number(scraped_rent),na.rm = T),
          length_1b=length(scraped_rent))
```

## Summarize the average square footage for 1, 2 and 3 bedroom units.

```{r}
summarize(filter(scraped, parse_number(scraped_beds) <= 3),
          mean_b=mean(parse_number(scraped_sqft),na.rm = T))
```

## Summarize the average number of bedrooms across months in the listing data.

```{r}
scraped %>% #take our listing data
  filter(!is.na(listing_date), !is.na(parse_number(scraped_rent))) %>% 
  group_by(month(listing_date)) %>% 
  summarize(med_rent = median(parse_number(scraped_rent))) 
```

## Create a summary table for the proportion of 1, 2 and 3 bedroom units with rents below Fair Market Rent levels set by the Department of Housing and Urban Development.

You will want to consult [this](https://www.rentdata.org/ithaca-ny-msa/2018) site for the FMR values. Hint: you could use `case_when()` to create a FMR column with each bedroom size's FMR value and then `mutate()` another column flagging if the row's rent was greater than or less than the FMR.

```{r}
scraped <- mutate(scraped, clean_beds = parse_number(scraped_beds))
scraped <- mutate(scraped, clean_beds = ifelse(clean_beds > 6, NA, clean_beds))
fmr <- scraped %>% 
mutate(limit = case_when( 
       clean_beds == 1 ~ 978, 
       clean_beds == 2 ~ 1164, 
       clean_beds == 3 ~ 1495))  %>% 
mutate(clean_rent < limit)
table(fmr$`clean_rent < limit`, useNA = "always")
sum(fmr$`clean_rent < limit`,na.rm = T)/length(scraped$clean_rent)
```
## If housing assistance allows households to rent units up to the FMR level, how much choice would you say they have on the rental markes? What policy proposals, if any, would you propose given the evidence you've generated using current rental listings?

They have 2716 kinds of choice. The houses with rents lower than FMR level is only 21% of the whole market. The rental market is overheating and mn people may can't afford the price. The government could subsidize the renters. Therefore, they will be more willing to set a lower price to meet the FMR standard. As the price decreases, more tenant could afford the price, solving the housing problem in the society.

<br>
<hr>
<br>

# Hands-on Task 2: Making some plots of the Craigslist data

## Create and interpret a scatterplot of square footage by rent asked for 2 bedroom listings using `ggplot()`.

```{r}
point <- scraped %>% filter(parse_number(scraped_beds)==2)
ggplot(point, aes(x = clean_sqft, y = clean_rent)) +
  geom_point()
```

## Create and interpret a bar chart of average square footage by bedroom size using `ggplot()`.

```{r}

sum_df <- scraped %>%
  group_by(clean_beds) %>%
  summarize(median = median(clean_sqft,na.rm = T))

ggplot(sum_df, aes(x = clean_beds, y = median)) +
  geom_bar(stat = "identity")
```

## Create and interpret a histogram of square footage using `ggplot()`.

```{r}
ggplot(point, aes(x = clean_sqft)) +
  geom_histogram()
```

## Create and interpret a ggplot of your choice using the listing data that incorporates the color aesthetic. 

```{r}
ggplot(scraped, aes(x = clean_sqft, y = clean_rent,color = clean_rent)) +
  geom_point()
```
This shows the relation between the rent and the the square footage. The lighter the point, the higher the rent. 


<br>
<hr>
<br>

# Hands-on Task 3: Correlation

## Estimate the correlation between square footage and rent overall and interpret this statistic.

```{r}
cor.test(scraped$clean_sqft,scraped$clean_rent,method = "pearson")
```
The p-value is smaller than 2.2e-16, the correlation is significant. The cor value is about 0.3,which is weak positive relation. This means higher square foot may leads to higher rent.
<br>
<hr>
<br>

# Hands-on Task 4: Make a map 

## Create a map of 2 bedroom units listed in May with `ggplot()` or `leaflet()`

```{r}
scraped <- scraped %>% 
  filter(month(listing_date)==5)
scraped <- st_set_crs(scraped, "EPSG:4326")
ggplot(scraped) +
  geom_sf()
leaflet(scraped) %>%
  addTiles() %>%
  addMarkers()
```

## Create a map of 1 bedroom units listed in May that have a rent asked that is below Fair Market Rent with `ggplot()` or `leaflet()` 

```{r}
scraped <- scraped %>% 
  filter(month(listing_date)==5,clean_beds==1,clean_rent<978)
scraped <- st_set_crs(scraped, "EPSG:4326")
ggplot(scraped) +
  geom_sf()
leaflet(scraped) %>%
  addTiles() %>%
  addMarkers()
```
